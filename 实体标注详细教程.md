# 实体标注详细教程

## 一、什么是实体标注？

实体标注就是在文本中标记出特定类型的信息。比如：

```
原文：今天温度是28摄氏度
标注后：
- "28" → 数值(NUM)
- "摄氏度" → 单位(UNIT)
```

## 二、标注的核心概念

### 2.1 实体的三要素

每个实体都包含三个关键信息：

1. **位置**：实体在文本中的起始和结束位置
2. **内容**：实体的文本内容
3. **类型**：实体的类别（如NUM、UNIT、TECH等）

### 2.2 位置计算方法

```python
文本 = "温度是25°C"
#      0123456789  (位置索引)

实体"25"：
- 起始位置：3
- 结束位置：5
- 类型：NUM

实体"°C"：
- 起始位置：5
- 结束位置：7
- 类型：UNIT
```

**重要**：位置从0开始计数，结束位置不包含（左闭右开）

## 三、BIO标注体系

### 3.1 标签含义

- **B-类型**：实体的开始（Begin）
- **I-类型**：实体的内部（Inside）
- **O**：非实体（Outside）

### 3.2 标注示例

```
文本：使用HPLC分析
字符：使 用 H P L C 分 析
标签：O  O  B-TECH I-TECH I-TECH I-TECH O O
```

### 3.3 为什么需要B和I？

区分实体边界，特别是连续实体：

```
文本：温度25°C湿度80%
标注：O O B-NUM I-NUM B-UNIT I-UNIT O O B-NUM I-NUM B-UNIT
```

## 四、手动标注步骤详解

### 步骤1：识别实体

阅读文本，找出需要标注的内容：

```
原文：FTIR测量显示在3000 cm⁻¹处有吸收峰

需要标注：
- FTIR → 技术术语
- 3000 → 数值
- cm⁻¹ → 单位
```

### 步骤2：确定位置

使用Python帮助计算位置：

```python
text = "FTIR测量显示在3000 cm⁻¹处有吸收峰"

# 方法1：使用find()
ftir_start = text.find("FTIR")  # 0
ftir_end = ftir_start + len("FTIR")  # 4

# 方法2：手动数
# F T I R 测 量 显 示 在 3  0  0  0     c  m  ⁻  ¹
# 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17
```

### 步骤3：创建标注

```python
{
    "text": "FTIR测量显示在3000 cm⁻¹处有吸收峰",
    "entities": [
        {"start": 0, "end": 4, "label": "TECH"},   # FTIR
        {"start": 9, "end": 13, "label": "NUM"},   # 3000
        {"start": 14, "end": 18, "label": "UNIT"}  # cm⁻¹
    ]
}
```

## 五、常见标注场景

### 5.1 中文数值+单位

```
文本：温度为100摄氏度
实体：
- "100" [3:6] → NUM
- "摄氏度" [6:9] → UNIT
```

### 5.2 英文缩写

```
文本：使用GC-MS检测
实体：
- "GC-MS" [2:7] → TECH
```

### 5.3 带小数的数值

```
文本：pH值为7.4
实体：
- "pH" [0:2] → UNIT
- "7.4" [4:7] → NUM
```

### 5.4 复合单位

```
文本：流速1.0 mL/min
实体：
- "1.0" [2:5] → NUM
- "mL/min" [6:12] → UNIT
```

## 六、使用Python辅助标注

### 6.1 位置计算工具

```python
def find_entity_positions(text, entity):
    """帮助找到实体的位置"""
    start = text.find(entity)
    if start != -1:
        end = start + len(entity)
        print(f"'{entity}' 的位置: [{start}:{end}]")
        print(f"验证: text[{start}:{end}] = '{text[start:end]}'")
        return start, end
    else:
        print(f"'{entity}' 未找到")
        return None, None

# 使用示例
text = "溶解度为5.5 mg/mL"
find_entity_positions(text, "5.5")     # [4:7]
find_entity_positions(text, "mg/mL")   # [8:13]
```

### 6.2 批量标注助手

```python
def create_annotation(text, entities_info):
    """
    entities_info: [(实体文本, 类型), ...]
    """
    entities = []
    for entity_text, label in entities_info:
        start = text.find(entity_text)
        if start != -1:
            end = start + len(entity_text)
            entities.append({
                "start": start,
                "end": end,
                "label": label
            })
    
    return {
        "text": text,
        "entities": entities
    }

# 使用示例
text = "使用HPLC分析，浓度为10 mg/L"
entities_info = [
    ("HPLC", "TECH"),
    ("10", "NUM"),
    ("mg/L", "UNIT")
]
result = create_annotation(text, entities_info)
```

### 6.3 验证标注正确性

```python
def verify_annotation(text, entities):
    """验证标注是否正确"""
    print(f"原文: {text}")
    print("-" * 40)
    
    for ent in entities:
        start = ent["start"]
        end = ent["end"]
        label = ent["label"]
        
        # 提取实体文本
        entity_text = text[start:end]
        
        print(f"位置[{start}:{end}] → '{entity_text}' ({label})")
        
        # 检查是否正确
        if not entity_text:
            print("  ⚠️ 警告：实体为空")
        elif entity_text.isspace():
            print("  ⚠️ 警告：实体只包含空格")

# 使用示例
text = "温度25°C"
entities = [
    {"start": 2, "end": 4, "label": "NUM"},
    {"start": 4, "end": 6, "label": "UNIT"}
]
verify_annotation(text, entities)
```

## 七、转换为训练格式

### 7.1 转为BIO格式

```python
def convert_to_bio(text, entities):
    """将实体标注转换为BIO格式"""
    # 初始化所有标签为O
    labels = ['O'] * len(text)
    
    for ent in entities:
        start = ent["start"]
        end = ent["end"]
        label = ent["label"]
        
        # 设置B标签
        labels[start] = f'B-{label}'
        
        # 设置I标签
        for i in range(start + 1, end):
            labels[i] = f'I-{label}'
    
    # 输出对齐的结果
    for char, label in zip(text, labels):
        print(f"{char:3} → {label}")
    
    return labels

# 使用示例
text = "温度25°C"
entities = [
    {"start": 2, "end": 4, "label": "NUM"},
    {"start": 4, "end": 6, "label": "UNIT"}
]
labels = convert_to_bio(text, entities)
```

输出：
```
温   → O
度   → O
2    → B-NUM
5    → I-NUM
°    → B-UNIT
C    → I-UNIT
```

## 八、常见错误及解决

### 8.1 位置偏移错误

❌ 错误示例：
```python
text = "温度是25度"
# 错误：把"是"也包含进去了
entities = [{"start": 2, "end": 5, "label": "NUM"}]  # "是25"
```

✅ 正确示例：
```python
entities = [{"start": 3, "end": 5, "label": "NUM"}]  # "25"
```

### 8.2 重叠标注

❌ 错误：两个实体重叠
```python
entities = [
    {"start": 0, "end": 5, "label": "TECH"},
    {"start": 3, "end": 7, "label": "NUM"}  # 重叠了！
]
```

✅ 正确：实体不应重叠

### 8.3 实体类型错误

❌ 错误示例：
```python
# "pH"是单位，不是数值
entities = [{"start": 0, "end": 2, "label": "NUM"}]  # pH
```

✅ 正确示例：
```python
entities = [{"start": 0, "end": 2, "label": "UNIT"}]  # pH
```

## 九、实战练习

### 练习1：标注简单句子

```python
text = "反应时间30分钟"
# 任务：标注"30"为NUM，"分钟"为UNIT

# 答案：
entities = [
    {"start": 4, "end": 6, "label": "NUM"},    # 30
    {"start": 6, "end": 8, "label": "UNIT"}    # 分钟
]
```

### 练习2：标注复杂句子

```python
text = "FTIR和XRD分析显示在252nm处"
# 任务：标注所有技术术语、数值和单位

# 答案：
entities = [
    {"start": 0, "end": 4, "label": "TECH"},   # FTIR
    {"start": 5, "end": 8, "label": "TECH"},   # XRD
    {"start": 13, "end": 16, "label": "NUM"},  # 252
    {"start": 16, "end": 18, "label": "UNIT"}  # nm
]
```

## 十、快速标注技巧

### 10.1 使用正则表达式找数字

```python
import re

def find_numbers(text):
    """自动找出所有数字"""
    pattern = r'\d+\.?\d*'
    for match in re.finditer(pattern, text):
        print(f"数字 '{match.group()}' 位置: [{match.start()}:{match.end()}]")

text = "温度25.5°C，湿度80%"
find_numbers(text)
# 输出：
# 数字 '25.5' 位置: [2:6]
# 数字 '80' 位置: [10:12]
```

### 10.2 使用词典匹配

```python
# 预定义的实体词典
TECH_TERMS = ["FTIR", "HPLC", "GC-MS", "NMR", "XRD", "DSC", "TGA"]
UNITS = ["°C", "mg/mL", "nm", "μm", "mL/min", "kPa", "%"]

def auto_label_with_dict(text):
    """使用词典自动标注"""
    entities = []
    
    # 查找技术术语
    for term in TECH_TERMS:
        if term in text:
            start = text.find(term)
            entities.append({
                "start": start,
                "end": start + len(term),
                "label": "TECH"
            })
    
    # 查找单位
    for unit in UNITS:
        if unit in text:
            start = text.find(unit)
            entities.append({
                "start": start,
                "end": start + len(unit),
                "label": "UNIT"
            })
    
    return entities
```

## 十一、标注质量检查清单

- [ ] 所有数值都标注为NUM了吗？
- [ ] 所有单位都标注为UNIT了吗？
- [ ] 所有技术术语都标注为TECH了吗？
- [ ] 实体边界准确吗（没有多包含或少包含字符）？
- [ ] 没有重叠的实体？
- [ ] 位置索引正确吗（text[start:end]能提取出正确的实体）？
- [ ] 实体类型分配正确吗？

## 十二、总结

1. **核心要点**：
   - 位置从0开始，左闭右开
   - B标记开始，I标记内部，O标记非实体
   - 实体不能重叠

2. **标注流程**：
   - 识别实体 → 确定位置 → 分配类型 → 验证正确性

3. **使用工具**：
   - Python辅助计算位置
   - 正则表达式批量查找
   - 词典匹配加速标注

通过大量练习，标注会变得越来越熟练和准确！